# üîí iOS Share Extension ‚Äî Security Checklist

**Feature:** "Share to BookMate"  
**Version:** v1.1.0  
**Security Review Date:** November 12, 2025  
**Classification:** Medium Risk (Handles PII)

---

## üéØ Security Overview

**Data Handled:**
- User receipts/invoices (may contain PII: names, addresses, account numbers)
- Authentication tokens (JWT)
- File metadata (device info, timestamps)

**Threat Model:**
- ‚ùå Malicious file upload (malware, executables)
- ‚ùå Token theft from device storage
- ‚ùå Unauthorized access to user files
- ‚ùå Man-in-the-middle attacks during upload
- ‚ùå PII retention on device after upload

---

## ‚úÖ Security Checklist

### 1. Authentication & Authorization

#### 1.1 Token Storage
- [ ] **Auth tokens stored in iOS Keychain** (not UserDefaults, not plaintext)
- [ ] **Keychain accessibility:** `kSecAttrAccessibleAfterFirstUnlock`
- [ ] **Tokens NOT stored in App Group** (use Keychain sharing if needed)
- [ ] **Token expiration enforced** (15 min access token, 7 day refresh token)
- [ ] **Expired tokens trigger re-authentication**

**Implementation Verification:**
```swift
// ‚úÖ CORRECT: Keychain storage
import Security

func saveToken(_ token: String) {
    let query: [String: Any] = [
        kSecClass as String: kSecClassGenericPassword,
        kSecAttrAccount as String: "bookmate_auth_token",
        kSecValueData as String: token.data(using: .utf8)!,
        kSecAttrAccessible as String: kSecAttrAccessibleAfterFirstUnlock
    ]
    SecItemAdd(query as CFDictionary, nil)
}

// ‚ùå WRONG: Plaintext storage
UserDefaults.standard.set(token, forKey: "auth_token")  // NEVER DO THIS
```

---

#### 1.2 Token Validation
- [ ] **Extension checks token validity before file save**
- [ ] **Expired token shows "Sign in Required" error (fail closed)**
- [ ] **No file saved to App Group without valid auth**
- [ ] **Host app validates token before upload**
- [ ] **Token refresh on 401 response**

---

#### 1.3 User Authorization
- [ ] **Only authenticated users can use extension**
- [ ] **User ID from token matches file metadata**
- [ ] **Backend validates user owns uploaded file**

---

### 2. File Validation & Sanitization

#### 2.1 MIME Type Validation
- [ ] **Allowed types:** `image/jpeg`, `image/png`, `image/heic`, `application/pdf` ONLY
- [ ] **Unsupported types rejected:** .exe, .zip, .docx, .txt, etc.
- [ ] **MIME type validated by content (magic number), not just extension**
- [ ] **Renamed executables rejected** (e.g., malware.exe ‚Üí malware.jpg)

**Magic Number Check:**
```swift
// ‚úÖ CORRECT: Validate by file content
func validateMimeType(_ url: URL) -> Bool {
    guard let fileHandle = try? FileHandle(forReadingFrom: url),
          let header = try? fileHandle.read(upToCount: 16) else {
        return false
    }
    
    // JPEG: FF D8 FF
    if header.starts(with: Data([0xFF, 0xD8, 0xFF])) { return true }
    
    // PNG: 89 50 4E 47
    if header.starts(with: Data([0x89, 0x50, 0x4E, 0x47])) { return true }
    
    // PDF: 25 50 44 46
    if header.starts(with: Data([0x25, 0x50, 0x44, 0x46])) { return true }
    
    return false
}
```

---

#### 2.2 File Size Validation
- [ ] **Maximum file size enforced:** 50MB
- [ ] **Files >50MB rejected with clear error**
- [ ] **Size check BEFORE copying to App Group**
- [ ] **Size validated on backend (double-check)**

---

#### 2.3 Filename Sanitization
- [ ] **Original filename sanitized** (remove `../`, `~`, special chars)
- [ ] **Storage filename generated by app** (no user-controlled names)
- [ ] **Path traversal attacks prevented**

**Sanitization:**
```swift
// ‚úÖ CORRECT: Sanitize user input
func sanitizeFilename(_ name: String) -> String {
    let forbidden = CharacterSet(charactersIn: "../~*?<>|:")
    return name.components(separatedBy: forbidden).joined()
}

// ‚úÖ BETTER: Generate controlled name
let storageName = FileNamer.generateName(originalURL: url)
// Result: "20251112_143022_a7f3e9d1.jpg" (safe, no user input)
```

---

#### 2.4 Malware Scanning (Future Enhancement)
- [ ] **v1.0:** Client-side validation only (MIME type + size)
- [ ] **v1.1:** Backend virus scan (ClamAV or cloud service)
- [ ] **v1.1:** Quarantine suspicious files for manual review

---

### 3. Data Privacy & PII Handling

#### 3.1 Temporary Storage
- [ ] **Files stored in App Group ONLY until uploaded**
- [ ] **App Group excluded from iCloud backup**
- [ ] **Files deleted from device after successful upload**
- [ ] **Failed uploads kept max 14 days, then deleted**

**iCloud Backup Exclusion:**
```swift
// ‚úÖ Exclude App Group from backups
let appGroupURL = FileManager.default.containerURL(
    forSecurityApplicationGroupIdentifier: "group.com.siamoon.bookmate"
)!

var resourceValues = URLResourceValues()
resourceValues.isExcludedFromBackup = true
try? appGroupURL.setResourceValues(resourceValues)
```

---

#### 3.2 PII Minimization
- [ ] **Only collect necessary metadata** (no GPS, no contacts, no camera model)
- [ ] **Device info limited to:** Model, iOS version, locale (for debugging)
- [ ] **No user name or email in file metadata**
- [ ] **User note field optional** (not required)

**Metadata Review:**
```json
// ‚úÖ SAFE: Minimal PII
{
  "device": {
    "model": "iPhone 15 Pro",  // Generic model (OK)
    "osVersion": "17.1.2",     // For compatibility (OK)
    "locale": "en_US"          // For localization (OK)
  }
}

// ‚ùå UNSAFE: Too much PII
{
  "device": {
    "udid": "...",             // Unique device ID (NO)
    "userName": "John Doe",    // User name (NO)
    "gpsLocation": "...",      // GPS coords (NO)
  }
}
```

---

#### 3.3 Data Retention
- [ ] **Device:** Files deleted after upload (max 7 days in `uploaded/`)
- [ ] **Backend:** Files retained per company policy (90 days default, configurable)
- [ ] **Right to Delete:** User can delete receipts from app (also deletes from backend)

---

### 4. Network Security

#### 4.1 Transport Security
- [ ] **All uploads via HTTPS (TLS 1.3)**
- [ ] **Certificate pinning enabled** (prevent MITM)
- [ ] **No HTTP fallback**
- [ ] **Backend enforces HTTPS only**

**Certificate Pinning (Optional Enhancement):**
```swift
// ‚úÖ Pin backend certificate
let session = URLSession(configuration: .default, delegate: self, delegateQueue: nil)

func urlSession(
    _ session: URLSession,
    didReceive challenge: URLAuthenticationChallenge,
    completionHandler: @escaping (URLSession.AuthChallengeDisposition, URLCredential?) -> Void
) {
    guard let serverTrust = challenge.protectionSpace.serverTrust else {
        completionHandler(.cancelAuthenticationChallenge, nil)
        return
    }
    
    // Validate against pinned certificate
    let policy = SecPolicyCreateSSL(true, "accounting.siamoon.com" as CFString)
    SecTrustSetPolicies(serverTrust, policy)
    
    var result: SecTrustResultType = .invalid
    SecTrustEvaluate(serverTrust, &result)
    
    if result == .unspecified || result == .proceed {
        completionHandler(.useCredential, URLCredential(trust: serverTrust))
    } else {
        completionHandler(.cancelAuthenticationChallenge, nil)
    }
}
```

---

#### 4.2 API Security
- [ ] **Bearer token sent in Authorization header** (not URL params)
- [ ] **Token never logged to console** (redact in logs)
- [ ] **Backend rate limiting:** 100 req/hour per user
- [ ] **Backend IP rate limiting:** 1000 req/hour per IP (prevent abuse)

---

### 5. Access Control

#### 5.1 App Group Permissions
- [ ] **App Group ID registered in Apple Developer Portal**
- [ ] **Only BookMate app + extension can access App Group**
- [ ] **Entitlements configured correctly in both targets**
- [ ] **No other apps can read App Group files**

**Entitlements Verification:**
```xml
<!-- ‚úÖ BookMate.entitlements -->
<key>com.apple.security.application-groups</key>
<array>
    <string>group.com.siamoon.bookmate</string>
</array>

<!-- ‚úÖ ShareExtension.entitlements -->
<key>com.apple.security.application-groups</key>
<array>
    <string>group.com.siamoon.bookmate</string>
</array>
```

---

#### 5.2 File Permissions
- [ ] **App Group files NOT world-readable**
- [ ] **File permissions:** Owner read/write only
- [ ] **Directory permissions:** Owner read/write/execute only

**Set Permissions:**
```swift
// ‚úÖ Set restrictive file permissions
let filePath = appGroupURL.appendingPathComponent("pending/file.jpg")
try FileManager.default.setAttributes(
    [.posixPermissions: 0o600],  // Owner read/write only
    ofItemAtPath: filePath.path
)
```

---

### 6. Logging & Monitoring

#### 6.1 Secure Logging
- [ ] **Production builds:** Minimal logging (errors only)
- [ ] **Development builds:** Verbose logging (disabled in release)
- [ ] **Never log:** Auth tokens, file content, PII
- [ ] **Redact sensitive data in logs**

**Logging Policy:**
```swift
// ‚úÖ SAFE: Log without PII
logger.info("File uploaded: id=\(fileId), size=\(sizeBytes)")

// ‚ùå UNSAFE: Logs PII
logger.debug("Uploaded receipt for John Doe at 123 Main St")  // NO

// ‚ùå UNSAFE: Logs token
logger.debug("Token: \(authToken)")  // NO
```

---

#### 6.2 Audit Trail
- [ ] **Backend logs all upload events** (user ID, file ID, timestamp)
- [ ] **Failed upload attempts logged** (for abuse detection)
- [ ] **Token refresh events logged**
- [ ] **Suspicious activity alerts** (e.g., 100+ uploads in 1 hour)

---

### 7. Error Handling

#### 7.1 Fail Securely
- [ ] **Default to deny:** If auth check fails, don't save file
- [ ] **No debug info in error messages** (production)
- [ ] **Generic errors shown to user** ("Upload failed. Try again.")
- [ ] **Detailed errors logged server-side only**

**Error Handling:**
```swift
// ‚úÖ CORRECT: Fail closed
guard let token = getAuthToken(), isTokenValid(token) else {
    // User not authenticated
    showError("Sign in Required")
    return  // Do NOT save file
}

// ‚ùå WRONG: Fail open
if let token = getAuthToken() {
    // User authenticated
    saveFile()
} else {
    // Save anyway? NO!
    saveFile()  // DANGEROUS
}
```

---

#### 7.2 User-Facing Error Messages
- [ ] **No technical details exposed** (e.g., "SQL error" or "Stack trace")
- [ ] **Clear, actionable messages** ("Sign in Required")
- [ ] **No internal paths or backend URLs in errors**

---

### 8. Code Security

#### 8.1 Code Obfuscation
- [ ] **Sensitive strings obfuscated** (API endpoints, keys)
- [ ] **No hardcoded secrets** (use environment variables or Keychain)
- [ ] **ProGuard/R8 enabled for release builds** (Android)
- [ ] **Strip debug symbols in release builds**

---

#### 8.2 Dependency Security
- [ ] **All npm/CocoaPods dependencies up to date**
- [ ] **No known vulnerabilities** (run `npm audit` / `pod audit`)
- [ ] **Only trusted, popular libraries used**
- [ ] **Minimal dependencies** (reduce attack surface)

**Dependency Audit:**
```bash
# Audit npm packages
npm audit --production

# Audit CocoaPods
bundle exec pod audit

# Fix vulnerabilities
npm audit fix
```

---

#### 8.3 Code Review
- [ ] **All code reviewed by senior iOS engineer**
- [ ] **Security-sensitive code reviewed by security lead**
- [ ] **No TODO/FIXME in production code** (especially security-related)

---

### 9. Testing & Validation

#### 9.1 Penetration Testing (Future)
- [ ] **v1.0:** Internal security review
- [ ] **v1.1:** External pen test (3rd-party security firm)
- [ ] **Test for:** OWASP Mobile Top 10 vulnerabilities

---

#### 9.2 Security Test Cases
- [ ] **Test: Share malicious .exe renamed to .jpg** ‚Üí Rejected
- [ ] **Test: Share file >50MB** ‚Üí Rejected
- [ ] **Test: Intercept upload (proxy)** ‚Üí HTTPS verified
- [ ] **Test: Access App Group from other app** ‚Üí Denied
- [ ] **Test: Extract token from device backup** ‚Üí Not found (Keychain only)

---

### 10. Compliance & Privacy

#### 10.1 GDPR Compliance (if applicable)
- [ ] **User consent obtained** (terms of service)
- [ ] **Right to access:** User can view all uploaded receipts
- [ ] **Right to delete:** User can delete receipts
- [ ] **Right to export:** User can export data (future)
- [ ] **Data minimization:** Only collect necessary data

---

#### 10.2 App Privacy Disclosures (App Store)
- [ ] **App Store privacy label updated**
- [ ] **Financial Info:** Collected (receipts)
- [ ] **User Content:** Collected (uploaded files)
- [ ] **Data NOT linked to user identity** (if anonymous mode)
- [ ] **Data NOT used for tracking**

**App Store Privacy Label:**
```
Data Collected:
‚úÖ Financial Info (Receipts, Invoices)
   - Used for App Functionality
   - Not Linked to You (if anonymous)
   - Not Used for Tracking

‚úÖ User Content (Uploaded Files)
   - Used for App Functionality
   - Linked to You (if user accounts)
   - Not Used for Tracking
```

---

### 11. Incident Response

#### 11.1 Security Incident Plan
- [ ] **Contact:** security@siamoon.com
- [ ] **Escalation path defined** (iOS Lead ‚Üí CTO ‚Üí CEO)
- [ ] **Incident response playbook created**
- [ ] **Data breach notification plan** (GDPR: 72 hours)

---

#### 11.2 Kill Switch (Emergency)
- [ ] **Remote config flag:** `share_extension_enabled`
- [ ] **Can disable feature remotely** (<5 min)
- [ ] **Users see "Feature temporarily unavailable"**
- [ ] **Files queued locally until re-enabled**

**Kill Switch Implementation:**
```swift
// Remote config check
func isShareExtensionEnabled() -> Bool {
    return RemoteConfig.shared.getBool("share_extension_enabled", defaultValue: true)
}

// In ShareViewController
override func viewDidLoad() {
    super.viewDidLoad()
    
    guard isShareExtensionEnabled() else {
        showError("Feature temporarily unavailable")
        dismissExtension()
        return
    }
    
    // Continue normal flow...
}
```

---

## üìã Pre-Launch Security Checklist

### Critical (Must Complete Before Launch)
- [ ] All authentication checks implemented and tested
- [ ] MIME type validation with magic number check
- [ ] File size validation (50MB limit)
- [ ] HTTPS enforced for all uploads
- [ ] Auth tokens stored in Keychain only
- [ ] Files deleted from device after upload
- [ ] App Group excluded from iCloud backup
- [ ] Error handling fails securely
- [ ] Code review completed by security lead
- [ ] Security test cases passed

### Recommended (Should Complete Before Launch)
- [ ] Certificate pinning enabled
- [ ] Dependency audit passed
- [ ] Logging redacts sensitive data
- [ ] Rate limiting configured
- [ ] Kill switch tested
- [ ] Incident response plan documented

### Future Enhancements (Post-Launch)
- [ ] External penetration testing
- [ ] Backend virus scanning
- [ ] Advanced threat detection
- [ ] SOC 2 compliance audit

---

## üîç Security Review Sign-Off

**iOS Lead:** ___________________________ Date: ___________

**Security Lead:** ______________________ Date: ___________

**CTO (if required):** ___________________ Date: ___________

---

**Status:** ‚úÖ Security Checklist Complete  
**Next:** Rollback plan and repository scoping  
**Review:** Pending Security Team approval

---

*Last Updated: November 12, 2025*  
*Document Owner: Security Lead + iOS Lead*  
*Classification: Internal Use Only*
